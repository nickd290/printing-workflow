generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Auth & Users
// ============================================================================

enum Role {
  CUSTOMER
  BROKER_ADMIN
  BRADFORD_ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // Hashed password (bcrypt) - null for OAuth-only users
  name          String?
  role          Role      @default(CUSTOMER)
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id])

  accounts      Account[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([companyId])
  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// ============================================================================
// Companies & Contacts
// ============================================================================

model Company {
  id        String   @id @default(cuid())
  name      String
  type      String   // "customer" | "broker" | "manufacturer"
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                 User[]
  contacts              Contact[]
  quoteRequestsAsCustomer QuoteRequest[] @relation("CustomerQuoteRequests")
  jobsAsCustomer        Job[] @relation("CustomerJobs")

  // POs where this company is the origin (buyer)
  purchaseOrdersAsOrigin PurchaseOrder[] @relation("OriginCompanyPOs")
  // POs where this company is the target (seller)
  purchaseOrdersAsTarget PurchaseOrder[] @relation("TargetCompanyPOs")

  // Invoices where this company is the recipient
  invoicesAsTo          Invoice[] @relation("InvoiceToCompany")
  // Invoices where this company is the sender
  invoicesAsFrom        Invoice[] @relation("InvoiceFromCompany")

  shipmentRecipients    ShipmentRecipient[]
}

model Contact {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name      String
  email     String
  phone     String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ============================================================================
// Quote Requests & Quotes
// ============================================================================

enum QuoteRequestStatus {
  PENDING
  QUOTED
  APPROVED
  REJECTED
}

model QuoteRequest {
  id         String             @id @default(cuid())
  customerId String
  customer   Company            @relation("CustomerQuoteRequests", fields: [customerId], references: [id])
  status     QuoteRequestStatus @default(PENDING)

  // Specifications (stored as JSON)
  specs      Json // { paper, size, quantity, colors, finishing, requestedDate, notes }

  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  quotes     Quote[]

  @@index([customerId])
  @@index([status])
}

model Quote {
  id             String       @id @default(cuid())
  quoteRequestId String
  quoteRequest   QuoteRequest @relation(fields: [quoteRequestId], references: [id], onDelete: Cascade)

  // Quote lines and totals
  lines          Json // Array of { description, quantity, unitPrice, total }
  subtotal       Decimal      
  tax            Decimal       @default(0)
  total          Decimal      

  validUntil     DateTime
  notes          String?

  approvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  jobs           Job[]

  @@index([quoteRequestId])
}

// ============================================================================
// Jobs
// ============================================================================

enum JobStatus {
  PENDING
  IN_PRODUCTION
  READY_FOR_PROOF
  PROOF_APPROVED
  COMPLETED
  CANCELLED
}

model Job {
  id         String    @id @default(cuid())
  jobNo      String    @unique // J-YYYY-NNNNNN

  quoteId    String?
  quote      Quote?    @relation(fields: [quoteId], references: [id])

  customerId String
  customer   Company   @relation("CustomerJobs", fields: [customerId], references: [id])

  status     JobStatus @default(PENDING)

  // Job details
  title          String?
  description    String?

  // Job specifications (from quote or direct order)
  specs      Json

  // Product details
  sizeId     String?   // 'SM_7_25_16_375', etc.
  sizeName   String?   // '7 1/4 x 16 3/8'
  quantity   Int?

  // CPM (Cost Per Thousand) rates
  customerCPM           Decimal?
  impactMarginCPM       Decimal?
  bradfordTotalCPM      Decimal?
  bradfordPrintMarginCPM  Decimal?
  bradfordPaperMarginCPM  Decimal?
  bradfordTotalMarginCPM  Decimal?
  printCPM              Decimal?
  paperCostCPM          Decimal?
  paperChargedCPM       Decimal?

  // Total amounts for this job
  customerTotal         Decimal
  impactMargin          Decimal?
  bradfordTotal         Decimal?
  bradfordPrintMargin   Decimal?  // Bradford's print profit
  bradfordPaperMargin   Decimal?  // Bradford's paper profit
  bradfordTotalMargin   Decimal?  // Total Bradford profit
  jdTotal               Decimal?
  paperCostTotal        Decimal?  // Actual paper cost
  paperChargedTotal     Decimal?  // What Bradford charges for paper

  // Paper specifications
  paperType             String?
  paperWeightTotal      Decimal?  // Total lbs for this job
  paperWeightPer1000    Decimal?  // Lbs per thousand pieces

  // Production & Delivery
  deliveryDate   DateTime?
  mailDate       DateTime?
  inHomesDate    DateTime?
  packingSlipNotes String?

  // Customer PO tracking
  customerPONumber String?
  customerPOFile   String? // Path to uploaded PO file

  // Approval workflow for custom pricing
  requiresApproval Boolean  @default(false) // True if custom price is below cost
  approvedBy       String?  // User ID who approved
  approvedAt       DateTime? // When it was approved

  // File requirements and production readiness
  requiredArtworkCount  Int?      // Number of artwork files required (from AI or manual)
  requiredDataFileCount Int?      // Number of data files required (from AI or manual)
  isReadyForProduction  Boolean   @default(false) // Auto-calculated when all files uploaded
  submittedForProductionAt DateTime? // When customer submitted job for production

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  completedAt DateTime?

  files      File[]
  proofs     Proof[]
  purchaseOrders PurchaseOrder[]
  invoices   Invoice[]
  shipments  Shipment[]
  sampleShipments SampleShipment[]
  notifications Notification[]
  activities JobActivity[]

  @@index([customerId])
  @@index([status])
  @@index([jobNo])
}

// Job Activity / Audit Log
model JobActivity {
  id            String   @id @default(cuid())
  jobId         String
  job           Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  action        String   // "UPDATED", "CREATED", "STATUS_CHANGED", etc.
  field         String?  // Field that was changed (e.g., "quantity", "deliveryDate")
  oldValue      String?  // Previous value (stored as string for flexibility)
  newValue      String?  // New value (stored as string for flexibility)

  changedBy     String   // User email or ID who made the change
  changedByRole Role     // User's role at time of change

  createdAt     DateTime @default(now())

  @@index([jobId])
  @@index([createdAt])
}

// ============================================================================
// Files
// ============================================================================

enum FileKind {
  ARTWORK
  DATA_FILE
  PROOF
  INVOICE
  PO_PDF
}

model File {
  id        String   @id @default(cuid())
  kind      FileKind
  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // S3 storage
  objectKey String   // S3 object key
  fileName  String   // Original filename
  mimeType  String
  size      Int      // bytes
  checksum  String   // SHA-256 hash

  uploadedBy String? // User ID
  createdAt  DateTime @default(now())

  proofs           Proof[]
  invoices         Invoice[]
  purchaseOrders   PurchaseOrder[] @relation("PurchaseOrderPDF")

  @@index([jobId])
  @@index([kind])
}

// ============================================================================
// Proofs
// ============================================================================

enum ProofStatus {
  PENDING
  APPROVED
  CHANGES_REQUESTED
}

model Proof {
  id        String      @id @default(cuid())
  jobId     String
  job       Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  version   Int         // Auto-increment per job
  status    ProofStatus @default(PENDING)

  fileId    String
  file      File        @relation(fields: [fileId], references: [id])

  // Admin notes/concerns when uploading proof
  adminNotes String?
  adminComments String?

  // Shareable link for customer proof approval
  shareToken     String?   @unique // UUID for public access
  shareExpiresAt DateTime? // Link expiration date

  approvals ProofApproval[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([jobId, version])
  @@index([jobId])
  @@index([shareToken])
}

model ProofApproval {
  id        String   @id @default(cuid())
  proofId   String
  proof     Proof    @relation(fields: [proofId], references: [id], onDelete: Cascade)

  approved  Boolean
  comments  String?
  approvedBy String? // User ID or email

  createdAt DateTime @default(now())

  @@index([proofId])
}

// ============================================================================
// Purchase Orders
// ============================================================================

enum POStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model PurchaseOrder {
  id              String   @id @default(cuid())

  // Origin company is the buyer
  originCompanyId String
  originCompany   Company  @relation("OriginCompanyPOs", fields: [originCompanyId], references: [id])

  // Target company is the seller
  targetCompanyId String
  targetCompany   Company  @relation("TargetCompanyPOs", fields: [targetCompanyId], references: [id])

  jobId           String?
  job             Job?     @relation(fields: [jobId], references: [id])

  // Amounts
  originalAmount  Decimal   // Customer's original payment
  vendorAmount    Decimal   // Amount to vendor
  marginAmount    Decimal   // Margin kept by origin company

  // PO Number tracking
  poNumber          String?   // This PO's number (Impact's PO# or Bradford's PO#)
  referencePONumber String?   // Reference to parent/customer PO#

  // External reference (e.g., from Bradford's system)
  externalRef     String?  // e.g., estimateNumber, componentId

  // Uploaded PO PDF (for Bradford â†’ JD)
  pdfFileId       String?
  pdfFile         File?    @relation("PurchaseOrderPDF", fields: [pdfFileId], references: [id])

  status          POStatus @default(PENDING)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([originCompanyId])
  @@index([targetCompanyId])
  @@index([jobId])
  @@index([externalRef])
  @@index([poNumber])
  @@index([referencePONumber])
}

// ============================================================================
// Invoices
// ============================================================================

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

model Invoice {
  id         String        @id @default(cuid())

  jobId      String?
  job        Job?          @relation(fields: [jobId], references: [id])

  // To company (customer)
  toCompanyId   String
  toCompany     Company    @relation("InvoiceToCompany", fields: [toCompanyId], references: [id])

  // From company (issuer)
  fromCompanyId String
  fromCompany   Company    @relation("InvoiceFromCompany", fields: [fromCompanyId], references: [id])

  invoiceNo  String        @unique
  amount     Decimal       
  status     InvoiceStatus @default(DRAFT)

  pdfFileId  String?
  pdfFile    File?         @relation(fields: [pdfFileId], references: [id])

  issuedAt   DateTime?
  dueAt      DateTime?
  paidAt     DateTime?

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([jobId])
  @@index([toCompanyId])
  @@index([fromCompanyId])
  @@index([status])
}

// ============================================================================
// Shipments
// ============================================================================

model Shipment {
  id           String   @id @default(cuid())
  jobId        String
  job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  carrier      String   // UPS, FedEx, etc.
  trackingNo   String?
  weight       Decimal?  // lbs
  boxes        Int?

  scheduledAt  DateTime?
  shippedAt    DateTime?
  deliveredAt  DateTime?

  recipients   ShipmentRecipient[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([jobId])
  @@index([trackingNo])
}

model ShipmentRecipient {
  id         String   @id @default(cuid())
  shipmentId String
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  companyId  String?
  company    Company? @relation(fields: [companyId], references: [id])

  name       String
  address    String
  city       String
  state      String
  zip        String
  phone      String?

  createdAt  DateTime @default(now())

  @@index([shipmentId])
}

model SampleShipment {
  id          String   @id @default(cuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  description String
  carrier     String
  trackingNo  String?

  recipientName  String
  recipientEmail String
  recipientAddress String?

  sentAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([jobId])
  @@index([trackingNo])
}

// ============================================================================
// Notifications
// ============================================================================

enum NotificationType {
  QUOTE_READY
  PROOF_READY
  PROOF_APPROVED
  SHIPMENT_SCHEDULED
  INVOICE_SENT
  PO_CREATED
  JOB_READY_FOR_PRODUCTION
  JOB_SUBMITTED_CONFIRMATION
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType

  jobId     String?
  job       Job?             @relation(fields: [jobId], references: [id], onDelete: Cascade)

  recipient String           // email address
  subject   String
  body      String

  sentAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([jobId])
  @@index([recipient])
}

// ============================================================================
// Webhooks
// ============================================================================

enum WebhookSource {
  ZAPIER
  BRADFORD
  EMAIL
}

model WebhookEvent {
  id        String        @id @default(cuid())
  source    WebhookSource
  payload   Json
  processed Boolean       @default(false)

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([source])
  @@index([processed])
}

// ============================================================================
// Paper Inventory
// ============================================================================

model PaperInventory {
  id            String   @id @default(cuid())
  rollType      String   // "20_7pt_matte", "18_7pt_matte", "15_7pt_matte", "20_9pt"
  rollWidth     Int      // 20, 18, or 15 inches
  paperPoint    Int      // 7 or 9 pt
  paperType     String   // "matte" or "standard"
  quantity      Int      // current stock count
  weightPerRoll Decimal? // lbs per roll
  reorderPoint  Int?     // alert threshold
  companyId     String   // "bradford"

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactions  PaperTransaction[]

  @@index([companyId])
  @@index([rollType])
}

model PaperTransaction {
  id          String          @id @default(cuid())
  inventoryId String
  inventory   PaperInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  type        String          // "ADD", "REMOVE", "ADJUST", "JOB_USAGE"
  quantity    Int             // positive for add, negative for remove
  jobId       String?         // if this was used for a job
  notes       String?
  userId      String?         // who made the change

  createdAt   DateTime        @default(now())

  @@index([inventoryId])
  @@index([jobId])
  @@index([createdAt])
}

// ============================================================================
// Pricing Rules
// ============================================================================

model PricingRule {
  id              String   @id @default(cuid())
  sizeName        String   @unique  // "26 x 9.75", "6 x 11", etc.
  baseCPM         Decimal  // Standard rate per thousand
  printCPM        Decimal  // What Bradford pays JD for printing per thousand

  // Paper specifications
  paperWeightPer1000  Decimal?  // Paper weight in lbs per thousand pieces
  paperCostPerLb      Decimal?  // Cost per pound of paper
  paperCPM            Decimal?  // Bradford's paper COST per thousand
  paperChargedCPM     Decimal?  // What Bradford CHARGES for paper per thousand (with markup)
  rollSize            Int?      // Roll size in inches (15, 18, or 20)

  isActive        Boolean  @default(true)
  notes           String?  // Optional notes about this pricing
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sizeName])
  @@index([isActive])
}
